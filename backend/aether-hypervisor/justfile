# Build the hypervisor with CAP_NET_ADMIN and CAP_SETPCAP capabilities
build:
    cargo build --release
    sudo setcap cap_net_admin,cap_setpcap+eip target/release/aether-hypervisor
    @echo "âœ… Built with CAP_NET_ADMIN and CAP_SETPCAP"

# Build and run the hypervisor
run: build
    ./target/release/aether-hypervisor

# Development build (debug mode)
dev:
    cargo build
    sudo setcap cap_net_admin,cap_setpcap+eip target/debug/aether-hypervisor
    ./target/debug/aether-hypervisor

# Check code without building
check:
    cargo check

# Run tests
test:
    cargo test

# Clean build artifacts
clean:
    cargo clean

# Clean up all VMs and resources (TAP devices, processes, files)
cleanup:
    @echo "ðŸ§¹ Cleaning up all VM resources..."
    @echo "   -> Killing Firecracker processes..."
    -pkill -9 firecracker 2>/dev/null || true
    @echo "   -> Removing TAP devices..."
    -@for tap in $$(ip link show | grep -o "tap-[^:]*" 2>/dev/null); do \
        sudo ip link delete $$tap 2>/dev/null || true; \
    done
    @echo "   -> Removing temporary files..."
    -rm -rf /tmp/aether-logs /tmp/aether-instances /tmp/firecracker_*.socket
    @echo "âœ… Cleanup complete!"

# Setup system (one-time: create netdev group and add user)
setup:
    sudo groupadd -f netdev
    sudo usermod -a -G netdev $(USER)
    @echo "âœ… Setup complete! Log out and back in for group changes to take effect."

# Format code
fmt:
    cargo fmt

# Run clippy linter
lint:
    cargo clippy
